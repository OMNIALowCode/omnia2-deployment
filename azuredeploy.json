{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "sqlServerAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the SQL Server - account is MyMisMaster or the variable sqlsrvmymisAdminLogin"
      }
    },
    "sendgridEmail": {
      "type": "string",
      "defaultValue": "Configure a SendGrid account",
      "metadata": {
        "description": "Email to be displayed on platform-sent emails"
      }
    },
    "sendgridUsername": {
      "type": "string",
      "metadata": {
        "description": "SendGrid login"
      }
    },
    "sendgridPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SendGrid login password"
      }
    },
    "administrationEmail": {
      "type": "string",
      "metadata": {
        "description": "Platform master email"
      }
    }
  },
  "variables": {
    "location": "[resourceGroup().location]",
    "sqlsrvmymisName": "[concat('sqlsrvmymis', uniqueString(resourceGroup().id))]",
    "sqlsrvmymisAdminLogin": "[concat('sqlsrvmymisAdminLogin', uniqueString(resourceGroup().id))]",
    "sqldbmymisName": "[concat('sqldbmymis', uniqueString(resourceGroup().id))]",
    "wsmymisName": "[concat('wsmymis', uniqueString(resourceGroup().id))]",
    "appsrvplanmymisName": "[concat('appsrvplanmymis', uniqueString(resourceGroup().id))]",
    "samymisName": "[concat('samymis', uniqueString(resourceGroup().id))]",
    "sqldbcollation": "SQL_Latin1_General_Cp1_CI_AS",
    "certificateName": "[concat('myMISCertificate',uniqueString(resourceGroup().id))]"
  },
  "resources": [
    {
      "name": "[variables('sqlsrvmymisName')]",
      "type": "Microsoft.Sql/servers",
      "location": "[resourceGroup().location]",
      "apiVersion": "2014-04-01-preview",
      "dependsOn": [ ],
      "tags": {
        "displayName": "sqlsrvmymis"
      },
      "properties": {
        "version": "12.0",
        "administratorLogin": "[variables('sqlsrvmymisAdminLogin')]",
        "administratorLoginPassword": "[parameters('sqlServerAdminPassword')]"
      },
      "resources": [
        {
          "name": "AllowAllWindowsAzureIps",
          "type": "firewallrules",
          "location": "[resourceGroup().location]",
          "apiVersion": "2014-04-01-preview",
          "dependsOn": [
            "[concat('Microsoft.Sql/servers/', variables('sqlsrvmymisName'))]"
          ],
          "properties": {
            "startIpAddress": "0.0.0.0",
            "endIpAddress": "0.0.0.0"
          }
        },
        {
          "apiVersion": "2014-04-01-preview",
          "dependsOn": [
            "[variables('sqlsrvmymisName')]"
          ],
          "location": "[resourceGroup().location]",
          "name": "[variables('sqldbmymisName')]",
          "properties": {
            "collation": "[variables('sqldbCollation')]",
            "edition": "Standard",
            "maxSizeBytes": "1073741824",
            "requestedServiceObjectiveName": "S0"
          },
          "tags": {
            "displayName": "sqldbmymis"
          },
          "type": "databases",
          "resources": [
            {
              "name": "Import",
              "type": "extensions",
              "apiVersion": "2014-04-01-preview",
              "dependsOn": [
                "[variables('sqlsrvmymisName')]",
                "[variables('sqldbmymisName')]"
              ],
              "properties": {
                "storageUri": "https://mymiswebdeploy.blob.core.windows.net/artifacts/mymisDefault.bacpac",
                "administratorLogin": "[variables('sqlsrvmymisAdminLogin')]",
                "administratorLoginPassword": "[parameters('sqlServerAdminPassword')]",
                "operationMode": "Import",
                "storageKeyType": "SharedAccessKey",
                "storageKey": "?"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "[variables('appsrvplanmymisName')]",
      "type": "Microsoft.Web/serverfarms",
      "location": "[resourceGroup().location]",
      "apiVersion": "2014-06-01",
      "dependsOn": [ ],
      "tags": {
        "displayName": "appsrvplanmymis"
      },
      "properties": {
        "name": "[variables('appsrvplanmymisName')]",
        "sku": "Basic",
        "workerSize": 0,
        "numberOfWorkers": 1
      }
    },
    {
      "name": "[variables('wsmymisName')]",
      "type": "Microsoft.Web/sites",
      "location": "[resourceGroup().location]",
      "apiVersion": "2015-08-01",
      "dependsOn": [
        "[concat('Microsoft.Web/serverfarms/', variables('appsrvplanmymisName'))]",
        "[concat('Microsoft.Web/certificates/', variables('certificateName'))]",
        "[concat('Microsoft.Sql/servers/', variables('sqlsrvmymisName'))]"
      ],
      "tags": {
        "[concat('hidden-related:', resourceGroup().id, '/providers/Microsoft.Web/serverfarms/', variables('appsrvplanmymisName'))]": "Resource",
        "displayName": "wsmymis"
      },
      "properties": {
        "name": "[variables('wsmymisName')]",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms/', variables('appsrvplanmymisName'))]"
      },
      "resources": [
        {
          "apiVersion": "2015-08-01",
          "name": "MSDeploy",
          "type": "extensions",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.Web/serverfarms/', variables('appsrvplanmymisName'))]",
            "[concat('Microsoft.Web/certificates/', variables('certificateName'))]",
            "[concat('Microsoft.Sql/servers/', variables('sqlsrvmymisName'))]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'))]",
            "[concat('Microsoft.Sql/servers/', variables('sqlsrvmymisName'), '/databases/', variables('sqldbmymisName'))]",
            "[concat('Microsoft.Sql/servers/', variables('sqlsrvmymisName'), '/databases/', variables('sqldbmymisName'), '/extensions/Import')]"
          ],
          "properties": {
            "packageUri": "https://mymiswebdeploy.blob.core.windows.net/artifacts/MyMis.Package.zip",
            "setParameters": {
              "IIS Web Application Name": "[variables('wsmymisName')]"
            }
          }
        },
        {
          "name": "appsettings",
          "apiVersion": "2015-08-01",
          "type": "config",
          "dependsOn": [
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'))]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/extensions/MSDeploy')]"
          ],
          "properties": {
            "AzureWebJobsDashboard": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('samymisName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('samymisName')), '2015-05-01-preview').key1)]",
            "AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('samymisName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('samymisName')), '2015-05-01-preview').key1)]",
            "MyMis.Options.HideGenericExceptions": "true",
            "MyMis.MasterAccount": "[parameters('administrationEmail')]",
            "MyMis.DefaultCompany": "mymis",
            "MyMis.Branding": "myMIS",
            "MyMis.MaxFileSizeInMB": "10",
            "MyMis.Storage.ConnectionString": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('samymisName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('samymisName')), '2015-05-01-preview').key1)]",
            "MyMis.SQL.Core.ConnectionString": "[concat('Data Source=',variables('sqlsrvmymisName'),'.database.windows.net;Initial Catalog=',variables('sqldbmymisName'),';user id=MyMisMaster;password=',parameters('sqlServerAdminPassword'),';MultipleActiveResultSets=True;Connection Timeout=60;')]",
            "MyMis.SQL.Deployment.ConnectionString": "[concat('Data Source=',variables('sqlsrvmymisName'),'.database.windows.net;Initial Catalog=',variables('sqldbmymisName'),';user id=', variables('sqlsrvmymisAdminLogin'), ';password=',parameters('sqlServerAdminPassword'),';MultipleActiveResultSets=True;Connection Timeout=60;')]",
            "MyMis.SQL.Tenant.ConnectionString": "Data Source=[SERVER];Initial Catalog=[DATABASE];persist security info=True;user id=[USERID];password=[PASSWORD];MultipleActiveResultSets=True;Connection Timeout=60;",
            "MyMis.SQL.Management.ConnectionString": "[concat('Data Source=[SERVER];Initial Catalog=[DATABASE];persist security info=True;user id=MyMisMaster;password=',parameters('sqlServerAdminPassword'),';MultipleActiveResultSets=True;Connection Timeout=60;')]",
            "MyMis.OAuth2.ClientID": "7b6a25222e65234e2d3c32616e",
            "MyMis.OAuth2.ClientSecret": "593d29374f694d6424524d7e7e6e657327433e2b4b2b5a3b473c325434",
            "MyMis.OAuth2.AuthorizationEndpoint": "[concat('https://',variables('wsmymisName'), '.azurewebsites.net', '/api/OAuth/Authorize')]",
            "MyMis.OAuth2.TokenEndpoint": "[concat('https://',variables('wsmymisName'), '.azurewebsites.net', '/api/OAuth/Token')]",
            "MyMis.API.Services.Endpoint": "[concat('https://',variables('wsmymisName'), '.azurewebsites.net', '/api/v1/')]",
            "MyMis.API.Account.Endpoint": "[concat('https://',variables('wsmymisName'), '.azurewebsites.net', '/api/')]",
            "MyMis.Web.Endpoint": "[concat('https://',variables('wsmymisName'), '.azurewebsites.net/')]",
            "MyMis.ScriptingEngine.Endpoint": "[concat('https://',variables('wsmymisName'), '.azurewebsites.net', '/scripting/v1/Script/Execute')]",
            "MyMis.ExtensibilityEngine.Endpoint": "[concat('https://',variables('wsmymisName'), '.azurewebsites.net', '/scripting/DUMMYURL')]",
            "MyMis.ConnectorHub.Endpoint": "[concat('https://',variables('wsmymisName'), '.azurewebsites.net', '/api/')]",
            "MyMis.Plugins.Directory": "Plugins\\Release\\",
            "Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('samymisName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('samymisName')), '2015-05-01-preview').key1)]",
            "MyMis.Certificate.Thumbprint": "7B055233E36CAF1AFD251D9A76DCB2C169A8073B",
            "WEBSITE_LOAD_CERTIFICATES": "7B055233E36CAF1AFD251D9A76DCB2C169A8073B",
            "MyMis.Notification.From": "[parameters('sendgridEmail')]",
            "MyMis.Notification.SendGrid.Credentials.Username": "[parameters('sendgridUsername')]",
            "MyMis.Notification.SendGrid.Credentials.Password": "[parameters('sendgridPassword')]",
            "MyMis.SQL.Tenant.DefaultServer": "[concat(variables('sqlsrvmymisName'),'.database.windows.net')]",
            "MyMis.SQL.Tenant.DefaultDatabase": "[variables('sqldbmymisName')]",
            "MyMis.DeploymentEnvironment": "AppService"

          }
        },
        {
          "name": "connectionstrings",
          "apiVersion": "2015-08-01",
          "type": "config",
          "dependsOn": [
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'))]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/extensions/MSDeploy')]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/config/appsettings')]"
          ],
          "properties": {
            "AzureWebJobsDashboard": {
              "type": "Custom",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('samymisName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('samymisName')), '2015-05-01-preview').key1)]"
            },
            "AzureWebJobsStorage": {
              "type": "Custom",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('samymisName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('samymisName')), '2015-05-01-preview').key1)]"
            },
            "MyMis.Storage.ConnectionString": {
              "type": "Custom",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('samymisName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('samymisName')), '2015-05-01-preview').key1)]"
            },
            "MyMis.SQL.Core.ConnectionString": {
              "value": "[concat('Data Source=',variables('sqlsrvmymisName'),'.database.windows.net;Initial Catalog=',variables('sqldbmymisName'),';user id=MyMisMaster;password=',parameters('sqlServerAdminPassword'),';MultipleActiveResultSets=True;Connection Timeout=60;')]",
              "type": "SQLAzure"
            }
          }
        },
        {
          "name": "web",
          "apiVersion": "2015-08-01",
          "type": "config",
          "dependsOn": [
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'))]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/extensions/MSDeploy')]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/config/connectionstrings')]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/config/appsettings')]"
          ],
          "properties": {
            "webSocketsEnabled": true,
            "alwaysOn": true,
            "virtualApplications": [
              {
                "virtualPath": "/",
                "physicalPath": "site\\wwwroot"
              },
              {
                "virtualPath": "/api",
                "physicalPath": "site\\wwwroot\\api"
              },
              {
                "virtualPath": "/scripting",
                "physicalPath": "site\\wwwroot\\scripting"
              }
            ]
          }
        },
        {
          "apiVersion": "2015-08-01",
          "dependsOn": [
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'))]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/extensions/MSDeploy')]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/config/connectionstrings')]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/config/appsettings')]",
            "[concat('Microsoft.Web/Sites/', variables('wsmymisName'), '/config/web')]"
          ],
          "name": "logs",
          "properties": {
            "applicationLogs": {
              "fileSystem": {
                "level": "Information",
                "retentionInMb": 100,
                "enabled": true
              }
            },
            "detailedErrorMessages": {
              "enabled": true
            },
            "failedRequestsTracing": {
              "enabled": true
            },
            "httpLogs": {
              "fileSystem": {
                "retentionInMb": 100,
                "enabled": true
              }
            }
          },
          "type": "config"
        }
      ]
    },
    {
      "name": "[variables('samymisName')]",
      "type": "Microsoft.Storage/storageAccounts",
      "location": "[resourceGroup().location]",
      "apiVersion": "2015-06-15",
      "dependsOn": [ ],
      "tags": {
        "displayName": "samymis"
      },
      "properties": {
        "accountType": "Standard_LRS"
      }
    },
    {
      "name": "[variables('certificateName')]",
      "apiVersion": "2015-08-01",
      "type": "Microsoft.Web/certificates",
      "dependsOn": [
        "[concat('Microsoft.Web/serverfarms/', variables('appsrvplanmymisName'))]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "pfxBlob": "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",
        "password": "4Amm!QVAi9Mt5l1p4u$oi*7th"
      }
    }
  ],
  "outputs": {
  }
}
